<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Map 1 — COVID-19 Rates Choropleth</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .map-overlay {
      position: absolute;
      background: rgba(255,255,255,0.9);
      font: 12px/18px Arial, sans-serif;
      padding: 10px;
      margin: 10px;
      border-radius: 4px;
    }
    #features { top: 0; left: 0; max-width: 260px; }
    #legend { bottom: 0; left: 0; }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="map-overlay" id="features"><strong>Hover a county</strong></div>
  <div class="map-overlay" id="legend"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoid2luc3R3MiIsImEiOiJjbWt5cm11djkwYW5xM2Zvam40MW05aG96In0.XgSPU6D4f-QStbCZyqGJCw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-96, 37.8],
      zoom: 3.6,
      projection: 'albers' // ✅ correct
    });

    let countyData = null;

    async function geojsonFetch() {
      const response = await fetch('assets/us-covid-2020-rates.geojson');
      countyData = await response.json();
    }

    map.on('load', async () => {
      await geojsonFetch(); // ✅ wait until countyData exists

      map.addSource('countyData', {
        type: 'geojson',
        data: countyData,
        promoteId: 'fips'
      });

      // Choropleth based on `rates` (cases per 1,000)
      map.addLayer({
        id: 'county-fill',
        type: 'fill',
        source: 'countyData',
        paint: {
          'fill-color': [
            'step',
            ['get', 'rates'],
            '#ffffcc',
            10, '#ffeda0',
            25, '#fed976',
            50, '#feb24c',
            75, '#fd8d3c',
            100, '#f03b20',
            150, '#bd0026'
          ],
          'fill-opacity': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            0.95,
            0.75
          ]
        }
      });

      // Hover outline
      map.addLayer({
        id: 'county-outline',
        type: 'line',
        source: 'countyData',
        paint: {
          'line-color': '#000',
          'line-width': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            2,
            0.2
          ]
        }
      });

      // Hover interaction
      const featuresBox = document.getElementById('features');
      let hoveredId = null;

      map.on('mousemove', 'county-fill', (e) => {
        map.getCanvas().style.cursor = 'pointer';

        const f = e.features && e.features[0];
        if (!f) return;

        const id = f.properties.fips;

        if (hoveredId !== null && hoveredId !== id) {
          map.setFeatureState({ source: 'countyData', id: hoveredId }, { hover: false });
        }
        hoveredId = id;
        map.setFeatureState({ source: 'countyData', id: hoveredId }, { hover: true });

        const p = f.properties;
        featuresBox.innerHTML = `
          <strong>${p.county}, ${p.state}</strong><br/>
          Rate: ${Number(p.rates).toFixed(1)} per 1,000<br/>
          Cases: ${Number(p.cases).toLocaleString()}<br/>
          Deaths: ${Number(p.deaths).toLocaleString()}
        `;
      });

      map.on('mouseleave', 'county-fill', () => {
        map.getCanvas().style.cursor = '';

        if (hoveredId !== null) {
          map.setFeatureState({ source: 'countyData', id: hoveredId }, { hover: false });
        }
        hoveredId = null;

        featuresBox.innerHTML = '<strong>Hover a county</strong>';
      });

      // Simple legend
      document.getElementById('legend').innerHTML = `
        <strong>Cases per 1,000</strong><br/>
        0–10<br/>10–25<br/>25–50<br/>50–75<br/>75–100<br/>100–150<br/>150+
      `;
    });
  </script>
</body>

</html>
